
{% if request.args.advanced != 'True' %}
<script type="text/javascript" src="{{ url_for('static', filename = 'js/vendor/leaflet-0.7.3/leaflet.js') }}"></script>
{% endif %}
<script type="text/javascript" src="{{ url_for('static', filename = 'vendor/mapbox/mapbox.js/v2.1.6/mapbox.standalone.js') }}"></script>

<script type="text/javascript" src="{{ url_for('static', filename = 'vendor/mapbox/Leaflet-pip/leaflet-pip.min.js') }}"></script>


<script type="application/javascript">

var extents_map = L.map('extents_map')
    .setView([38, -115], 4);

// create the OpenStreetMap layer
osmTile = "http://tile.openstreetmap.org/{z}/{x}/{y}.png";
osmCopyright = "Map data &copy; 2012 OpenStreetMap contributors";
osmLayer = new L.TileLayer(osmTile, { maxZoom: 18, attribution: osmCopyright } );
extents_map.addLayer(osmLayer);

var layers = []

{% for result in search_result_records %}
{% if result['geographicExtents'] %}

var pub_{{ result['indexId'] }} = L.mapbox.featureLayer({{ result['geographicExtents']|tojson|safe }})
    .on('click', handleClick)
    .on('ready', resetStyles)
    .addTo(extents_map);

layers.push({ name: 'pub_{{ result['indexId'] }}', layer: pub_{{ result['indexId'] }} });

{% endif %}

{% endfor %}



// This is the default style of layers when the user isn't interacting
// with the map
var quiet = {
    fillColor: '#222',
    fillOpacity: 0.2,
    opacity: 0.4,
    weight: 1
};

// The style of a layer that's been filtered to but not the specific
// shape the user selected
var medium = {
    fillColor: '#255',
    fillOpacity: 1,
    opacity: 1,
    weight: 1
};

// The specific shape selected
var loud = {
    fillColor: '#2ff',
    fillOpacity: 0.8,
    opacity: 0.2,
    weight: 1
};

// When the user resets the map by closing the popup, reset styles
function resetStyles() {
    for (var i = 0; i < layers.length; i++) {
        layers[i].layer.setStyle(quiet);
    }
}

extents_map.on('popupclose', function() {
    resetStyles();
});

function handleClick(e) {
    var html = '';
    // look through each layer in order and see if the clicked point,
    // e.latlng, overlaps with one of the shapes in it.
    for (var i = 0; i < layers.length; i++) {
        var match = leafletPip.pointInLayer(
            // the clicked point
            e.latlng,
            // this layer
            layers[i].layer,
            // whether to stop at first match
            false);
        // if there's overlap, add some content to the popup: the layer name
        // and a table of attributes
        if (match.length) {
            html += '<button onclick="highlightMatch(this)" data-layer="' + i +
                '" data-latlng="' + [e.latlng.lat, e.latlng.lng] + '">highlight</button>';
            html += '<a href="'+match[0].feature.properties.url+'" >  '+  match[0].feature.properties.Title+'</a></br>';
        }
    }
    if (html) {
        extents_map.openPopup(html, e.latlng);
    }
}

// To highlight a layer, we make all other layers quiet and then re-run
// the point in polygon match on that layer
function highlightMatch(that) {
    var layer = layers[that.dataset.layer].layer,
        latlng = L.latLng(that.dataset.latlng.split(','));

    for (var i = 0; i < layers.length; i++) {
        if (layers[i].layer == layer) {
            var match = leafletPip.pointInLayer(latlng, layers[i].layer, true);
            layers[i].layer.eachLayer(function(shape) {
                if (match[0] == shape) {
                    // the one shape that is matched becomes loud and clear
                    shape.setStyle(loud);
                } else {
                    shape.setStyle(medium);
                }
            });
        } else {
            layers[i].layer.setStyle(quiet);
        }
    }
}

// create a simple table from the properties in a feature, like the
// name of a state or district
function propertyTable(o) {
    var t = '<table>';
    for (var k in o) {
        t += '<tr><th class=extents_th>' + k + '</th><td>' + o[k] + '</td></tr>';
    }
    t += '</table>';
    return t;
}
</script>